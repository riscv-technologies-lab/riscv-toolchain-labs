<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Toolchain - Introduction to cross-toolchains for RISC-V</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Instructions</li><li class="chapter-item expanded "><a href="../01-intro-to-cross/00-title-page.html"><strong aria-hidden="true">1.</strong> Introduction to cross compilation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01-intro-to-cross/01-hello-riscv.html"><strong aria-hidden="true">1.1.</strong> Hello World!</a></li></ol></li><li class="chapter-item expanded "><a href="../02-toolchain/02-toolchain.html" class="active"><strong aria-hidden="true">2.</strong> Toolchain</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02-toolchain/02-live-coding.html"><strong aria-hidden="true">2.1.</strong> Live Coding</a></li></ol></li><li class="chapter-item expanded "><a href="../03-linkers/03-linkers.html"><strong aria-hidden="true">3.</strong> Linkers</a></li><li class="chapter-item expanded "><a href="../04-linux-intro/00-linux-intro.html"><strong aria-hidden="true">4.</strong> Linux intro</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../04-linux-intro/01-preparations.html"><strong aria-hidden="true">4.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="../04-linux-intro/02-boot-revyos-linux-qemu.html"><strong aria-hidden="true">4.2.</strong> RevyOS on QEMU</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Introduction to cross-toolchains for RISC-V</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/riscv-technologies-lab/riscv-toolchain-labs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="downloading-toolchain-and-compiling-your-own"><a class="header" href="#downloading-toolchain-and-compiling-your-own">Downloading toolchain and compiling your own</a></h2>
<p>In this lab you will take a look at GNU and LLVM toolchains, where to find them and how to setup them
on your system.
You will also get acquainted with docker and its applications, we will use docker image with
prebuilt sc-dt package, which includes GNU ang LLVM toolchains.</p>
<h3 id="docker-usage"><a class="header" href="#docker-usage">Docker usage</a></h3>
<p>Navigate to <a href="https://github.com/riscv-technologies-lab/testgen-lectures/tree/main/tutorials">docker tutorials</a>
in order to setup your docker.</p>
<p>Pull image and run container:</p>
<pre><code class="language-bash">docker run \
    --interactive \
    --tty \
    --detach \
    --env &quot;TERM=xterm-256color&quot; \
    --mount type=bind,source=&quot;$(pwd)&quot;,target=&quot;$(pwd)&quot; \
    --name cpp \
    --ulimit nofile=1024:1024 \
    ghcr.io/riscv-technologies-lab/rv_tools_image:1.0.1
</code></pre>
<p>Wait for the image to pull, then you will enter the container.</p>
<h3 id="glancing-at-your-first-toolchain"><a class="header" href="#glancing-at-your-first-toolchain">Glancing at your first toolchain</a></h3>
<p>The docker container has both GNU and LLVM toolchains in it. They are both installed in <code>/opt/sc-dt/</code> directory.</p>
<p>Here is the GNU toolchain: <code>/opt/sc-dt/riscv-gcc</code>
And here is the LLVM toolchain: <code>/opt/sc-dt/llvm/</code></p>
<p>You will also see <code>env.sh</code> script in <code>/opt/sc-dt/</code> directory. This script exports environment variables to
your environment. Try running following:</p>
<pre><code class="language-bash">source /opt/sc-dt/env.sh
</code></pre>
<p><em>Task</em>: what changed after running the script? Take a look at your environmental variables before and after running the script. Compare and provide description. What does <code>source</code> command do?</p>
<p>Now you can access toolchains from <code>sc-dt</code> with either absolute typing: <code>/opt/sc-dt/riscv-gcc/</code> or
using environmental variable: <code>$SC_GCC_PATH/</code></p>
<p>Navigate to <code>labs/02-toolchain/</code> directory.
Take a look at <code>hello.c</code>, this is the same program you tried at the previous lab, and the same <code>Makefile</code>.
We will use those with our new toolchain.</p>
<p>As you can see in the <code>Makefile</code>, there are a few variables at the top:</p>
<pre><code class="language-makefile">CC ?= gcc
QEMU_USER ?= qemu-x86_64
CCFLAGS ?= 
</code></pre>
<p>It is a very common and a good practice to set such variables and use them throughout the Makefile.
The reason is, it is much more readable, and they can be redefined with some new value. For instance,
we can change the compiler, change the flags while using the same Makefile for our program.</p>
<p>Let's change the default compile in our <code>Makefile</code> to the one from sc-dt GNU toolchain:</p>
<p><em>Note</em>: how do variables work in shell? Try accomplishing the same goal using <code>export</code> and explain the difference.</p>
<pre><code class="language-bash">CC=/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gcc QEMU_USER=/opt/sc-dt/tools/bin/qemu-riscv64 make build
</code></pre>
<p>Remember, if you encounter error like the following:</p>
<pre><code>qemu-riscv64: Could not open '/lib/ld-linux-riscv64-lp64d.so.1': No such file or directory
</code></pre>
<p>Pass additionally <code>CFLAGS=-static</code> along with <code>CC</code> and <code>QEMU_USER</code></p>
<p>We redefined the <code>CC</code>, <code>CFLAGS</code> and  <code>QEMU_USER</code> variables to different value and ran build command. We see now that it ran successfully using specified compiler:</p>
<pre><code class="language-bash">/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gcc  hello.c -o build/hello.elf
</code></pre>
<p>Now run on QEMU:</p>
<pre><code>CC=/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gcc QEMU_USER=/opt/sc-dt/tools/bin/qemu-riscv64 CFLAGS=-static make run-qemu
</code></pre>
<h3 id="connecting-with-debugger"><a class="header" href="#connecting-with-debugger">Connecting with debugger</a></h3>
<p>It's time for us to use the debugger. We'll stick with GDB from sc-dt for now.</p>
<p>The debugger is located at <code>$SC_GCC_PATH/bin/riscv64-unknown-linux-gnu-gdb</code></p>
<p>First, add <code>-g</code> to <code>CFLAGS</code> variable. This adds debug symbols to final binary.
They significantly affect binary size, but without them we cannot to proper debugging.
<em>Task</em>: compare binary size with and without debug symbols enabled. Use <code>objdump</code> tool from
toolchain to find those debug symbols added by compiler.</p>
<p>Now connect to qemu, make it wait for gdb connection:</p>
<p><code>/opt/sc-dt/tools/bin/qemu-riscv64 -g 1234 build/hello.elf</code></p>
<p>Open another terminal, and use gdb to connect to it:</p>
<p><code>/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gdb</code></p>
<p>Inside gdb, connect to qemu by port 1234. Set breakpoint on main and run application:</p>
<pre><code>target remote localhost:1234 # note: you can use &quot;tar rem :1234&quot;
b main
continue
</code></pre>
<p>Now you should see following:</p>
<pre><code class="language-shell">(gdb) tar rem :1234
Remote debugging using :1234
Reading /home/stanislav/mipt/masters/riscv-toolchain-labs/labs/02-toolchain/fibb.elf from remote target...
warning: File transfers from remote targets can be slow. Use &quot;set sysroot&quot; to access files locally instead.
Reading /home/stanislav/mipt/masters/riscv-toolchain-labs/labs/02-toolchain/fibb.elf from remote target...
Reading symbols from target:/home/stanislav/mipt/masters/riscv-toolchain-labs/labs/02-toolchain/fibb.elf...
0x000000000001054c in _start ()
(gdb)
</code></pre>
<h3 id="major-tasks"><a class="header" href="#major-tasks">Major tasks</a></h3>
<h4 id="porting-application-to-risc-v"><a class="header" href="#porting-application-to-risc-v">Porting application to RISC-V</a></h4>
<p>In this task, you must choose an application you will be porting (for instance, your application for quadratic equation solution) and port it to RISC-V:</p>
<ul>
<li>Create a Makefile for your application. Makefile should have build and run on qemu targets, you must be able to change compiler and simulator (and also compilation flags)</li>
<li>For convenience, add Makefile target that runs on qemu / runs gdb / builds application using docker instead console:</li>
</ul>
<pre><code class="language-shell">make build-docker # This will enter docker container and build application inside it
</code></pre>
<ul>
<li>Build your app, verify that it runs on a simulator</li>
<li>Build with both GNU and LLVM toolchain. Try different optimization levels, compare assemblers. Compare them and list some differences.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../01-intro-to-cross/01-hello-riscv.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../02-toolchain/02-live-coding.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../01-intro-to-cross/01-hello-riscv.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../02-toolchain/02-live-coding.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
