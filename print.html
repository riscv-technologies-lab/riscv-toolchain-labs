<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction to cross-toolchains for RISC-V</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Instructions</li><li class="chapter-item expanded "><a href="01-intro-to-cross/00-title-page.html"><strong aria-hidden="true">1.</strong> Introduction to cross compilation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="01-intro-to-cross/01-hello-riscv.html"><strong aria-hidden="true">1.1.</strong> Hello World!</a></li></ol></li><li class="chapter-item expanded "><a href="02-toolchain/02-toolchain.html"><strong aria-hidden="true">2.</strong> Toolchain</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="02-toolchain/02-live-coding.html"><strong aria-hidden="true">2.1.</strong> Live Coding</a></li></ol></li><li class="chapter-item expanded "><a href="03-linkers/03-linkers.html"><strong aria-hidden="true">3.</strong> Linkers</a></li><li class="chapter-item expanded "><a href="04-linux-intro/00-linux-intro.html"><strong aria-hidden="true">4.</strong> Linux intro</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="04-linux-intro/01-preparations.html"><strong aria-hidden="true">4.1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="04-linux-intro/02-boot-revyos-linux-qemu.html"><strong aria-hidden="true">4.2.</strong> RevyOS on QEMU</a></li></ol></li><li class="chapter-item expanded "><a href="05-buildroot/00-intro.html"><strong aria-hidden="true">5.</strong> Buildroot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="05-buildroot/01-building.html"><strong aria-hidden="true">5.1.</strong> Building an image for LP4A</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Introduction to cross-toolchains for RISC-V</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/riscv-technologies-lab/riscv-toolchain-labs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction-to-cross-compilation"><a class="header" href="#introduction-to-cross-compilation">Introduction to cross-compilation</a></h1>
<p>This lesson shall serve as an introduction to cross-compilation and user mode
emulation. We assume the reader has some previous knowledge of C/C++ languages
and is familiar with linux and command line. It's recommended to review the following
resources before diving into practical aspects:</p>
<ul>
<li><a href="http://landley.net/writing/docs/cross-compiling.html">Introduction to cross-compiling for Linux</a></li>
<li><a href="https://youtu.be/335ylTUlyng?si=VbfusqEvtgz4_iNL">Toolchain &amp; Pony ü¶Ñ</a></li>
</ul>
<p>In this lesson you will learn how to build a simple C program targeting with cross-gcc toolchain targeting riscv64 arch
and run it on your computer via <a href="https://www.qemu.org/docs/master/user/main.html">qemu-user</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="compiling-our-first-hello-world-program"><a class="header" href="#compiling-our-first-hello-world-program">Compiling our first hello world program</a></h2>
<p>First clone this <a href="https://github.com/riscv-technologies-lab/riscv-toolchain-labs">repo</a> and install the cross toolchain for riscv64.
This depends on your distribution. We assume a debian based operating system, but feel free to use any distro you want.</p>
<pre><code class="language-bash">sudo apt install build-essential gcc-riscv64-linux-gnu qemu-user
</code></pre>
<p>Clone and navigate to the <code>labs/01-hello-riscv</code> directory:</p>
<pre><code class="language-bash">git clone https://github.com/riscv-technologies-lab/riscv-toolchain-labs.git cross-labs
cd cross-labs/labs/01-hello-riscv
</code></pre>
<p>Let's compile a simple hello world program natively. Take a look at
the <code>Makefile</code> that we've prepared.</p>
<pre><code class="language-c">{{#include ../../labs/01-hello-riscv/hello.c}}
</code></pre>
<pre><code class="language-bash">make run # compile the program natively
# gcc hello.c -o build/hello.elf
# build/hello.elf
# Hello, RISC-V!
</code></pre>
<p>Let's take a look at the generated executable with <code>file</code> command:</p>
<pre><code class="language-bash">make show # run: file build/hello.elf
# gcc hello.c -o build/hello.elf
# file build/hello.elf
# build/hello.elf: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=52deb0fc601275b33ab8a638447f4bf2dcc1bb4a, for GNU/Linux 3.2.0, not stripped
</code></pre>
<p>We can dig deeper with <code>ldd</code> <a href="https://man7.org/linux/man-pages/man1/ldd.1.html">command</a>.</p>
<pre><code class="language-bash">ldd build/hello.elf
# linux-vdso.so.1 (0x00007fff042e9000)
# libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f058ff59000)
# /lib64/ld-linux-x86-64.so.2 (0x00007f0590169000)
</code></pre>
<p>What is <a href="https://man7.org/linux/man-pages/man7/vdso.7.html">vDSO</a>?
Now run <code>readelf</code> utility on the compiled binary and take explore the output by yourself.
What happens if you compile with <code>CCFLAGS=-static</code> and run <code>readelf</code> again? Why is the output bigger?</p>
<h2 id="running-under-qemu-usermode-emulation"><a class="header" href="#running-under-qemu-usermode-emulation">Running under qemu usermode emulation</a></h2>
<p>Run <code>hello.elf</code> with native <a href="https://www.qemu.org/docs/master/user/main.html">usermode qemu</a>.
There's a make target to do that:</p>
<pre><code>make run-qemu
</code></pre>
<h2 id="compile-and-run-for-riscv64-arch"><a class="header" href="#compile-and-run-for-riscv64-arch">Compile and run for riscv64 arch</a></h2>
<p>Repeat the previous steps but with <code>riscv64</code> toolchain. You can set make variables
from command line, if they are defined with <code>?=</code>. Take a look <a href="https://ftp.gnu.org/old-gnu/Manuals/make-3.79.1/html_chapter/make_6.html#SEC58">here</a>.
Set the compiler to <code>riscv64-linux-gnu-gcc</code> and qemu executable to <code>qemu-riscv64</code>.
On ubuntu-23.04 <code>make run-qemu</code> fails with <code>Could not open '/lib/ld-linux-riscv64-lp64d.so.1'</code>.
In case you encounter such an error run you can either compile with <code>-static</code> flag or create
symlink <code>riscv64-linux-gnu-ld</code> with <code>ln -s</code> to the correct location. See the <a href="https://github.com/riscv-non-isa/riscv-elf-psabi-doc/issues/114">issue</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="downloading-toolchain-and-compiling-your-own"><a class="header" href="#downloading-toolchain-and-compiling-your-own">Downloading toolchain and compiling your own</a></h2>
<p>In this lab you will take a look at GNU and LLVM toolchains, where to find them and how to setup them
on your system.
You will also get acquainted with docker and its applications, we will use docker image with
prebuilt sc-dt package, which includes GNU ang LLVM toolchains.</p>
<h3 id="docker-usage"><a class="header" href="#docker-usage">Docker usage</a></h3>
<p>Navigate to <a href="https://github.com/riscv-technologies-lab/testgen-lectures/tree/main/tutorials">docker tutorials</a>
in order to setup your docker.</p>
<p>Pull image and run container:</p>
<pre><code class="language-bash">docker run \
    --interactive \
    --tty \
    --detach \
    --env &quot;TERM=xterm-256color&quot; \
    --mount type=bind,source=&quot;$(pwd)&quot;,target=&quot;$(pwd)&quot; \
    --name cpp \
    --ulimit nofile=1024:1024 \
    ghcr.io/riscv-technologies-lab/rv_tools_image:1.0.1
</code></pre>
<p>Wait for the image to pull, then you will enter the container.</p>
<h3 id="glancing-at-your-first-toolchain"><a class="header" href="#glancing-at-your-first-toolchain">Glancing at your first toolchain</a></h3>
<p>The docker container has both GNU and LLVM toolchains in it. They are both installed in <code>/opt/sc-dt/</code> directory.</p>
<p>Here is the GNU toolchain: <code>/opt/sc-dt/riscv-gcc</code>
And here is the LLVM toolchain: <code>/opt/sc-dt/llvm/</code></p>
<p>You will also see <code>env.sh</code> script in <code>/opt/sc-dt/</code> directory. This script exports environment variables to
your environment. Try running following:</p>
<pre><code class="language-bash">source /opt/sc-dt/env.sh
</code></pre>
<p><em>Task</em>: what changed after running the script? Take a look at your environmental variables before and after running the script. Compare and provide description. What does <code>source</code> command do?</p>
<p>Now you can access toolchains from <code>sc-dt</code> with either absolute typing: <code>/opt/sc-dt/riscv-gcc/</code> or
using environmental variable: <code>$SC_GCC_PATH/</code></p>
<p>Navigate to <code>labs/02-toolchain/</code> directory.
Take a look at <code>hello.c</code>, this is the same program you tried at the previous lab, and the same <code>Makefile</code>.
We will use those with our new toolchain.</p>
<p>As you can see in the <code>Makefile</code>, there are a few variables at the top:</p>
<pre><code class="language-makefile">CC ?= gcc
QEMU_USER ?= qemu-x86_64
CCFLAGS ?= 
</code></pre>
<p>It is a very common and a good practice to set such variables and use them throughout the Makefile.
The reason is, it is much more readable, and they can be redefined with some new value. For instance,
we can change the compiler, change the flags while using the same Makefile for our program.</p>
<p>Let's change the default compile in our <code>Makefile</code> to the one from sc-dt GNU toolchain:</p>
<p><em>Note</em>: how do variables work in shell? Try accomplishing the same goal using <code>export</code> and explain the difference.</p>
<pre><code class="language-bash">CC=/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gcc QEMU_USER=/opt/sc-dt/tools/bin/qemu-riscv64 make build
</code></pre>
<p>Remember, if you encounter error like the following:</p>
<pre><code>qemu-riscv64: Could not open '/lib/ld-linux-riscv64-lp64d.so.1': No such file or directory
</code></pre>
<p>Pass additionally <code>CFLAGS=-static</code> along with <code>CC</code> and <code>QEMU_USER</code></p>
<p>We redefined the <code>CC</code>, <code>CFLAGS</code> and  <code>QEMU_USER</code> variables to different value and ran build command. We see now that it ran successfully using specified compiler:</p>
<pre><code class="language-bash">/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gcc  hello.c -o build/hello.elf
</code></pre>
<p>Now run on QEMU:</p>
<pre><code>CC=/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gcc QEMU_USER=/opt/sc-dt/tools/bin/qemu-riscv64 CFLAGS=-static make run-qemu
</code></pre>
<h3 id="connecting-with-debugger"><a class="header" href="#connecting-with-debugger">Connecting with debugger</a></h3>
<p>It's time for us to use the debugger. We'll stick with GDB from sc-dt for now.</p>
<p>The debugger is located at <code>$SC_GCC_PATH/bin/riscv64-unknown-linux-gnu-gdb</code></p>
<p>First, add <code>-g</code> to <code>CFLAGS</code> variable. This adds debug symbols to final binary.
They significantly affect binary size, but without them we cannot to proper debugging.
<em>Task</em>: compare binary size with and without debug symbols enabled. Use <code>objdump</code> tool from
toolchain to find those debug symbols added by compiler.</p>
<p>Now connect to qemu, make it wait for gdb connection:</p>
<p><code>/opt/sc-dt/tools/bin/qemu-riscv64 -g 1234 build/hello.elf</code></p>
<p>Open another terminal, and use gdb to connect to it:</p>
<p><code>/opt/sc-dt/riscv-gcc/bin/riscv64-unknown-linux-gnu-gdb</code></p>
<p>Inside gdb, connect to qemu by port 1234. Set breakpoint on main and run application:</p>
<pre><code>target remote localhost:1234 # note: you can use &quot;tar rem :1234&quot;
b main
continue
</code></pre>
<p>Now you should see following:</p>
<pre><code class="language-shell">(gdb) tar rem :1234
Remote debugging using :1234
Reading /home/stanislav/mipt/masters/riscv-toolchain-labs/labs/02-toolchain/fibb.elf from remote target...
warning: File transfers from remote targets can be slow. Use &quot;set sysroot&quot; to access files locally instead.
Reading /home/stanislav/mipt/masters/riscv-toolchain-labs/labs/02-toolchain/fibb.elf from remote target...
Reading symbols from target:/home/stanislav/mipt/masters/riscv-toolchain-labs/labs/02-toolchain/fibb.elf...
0x000000000001054c in _start ()
(gdb)
</code></pre>
<h3 id="major-tasks"><a class="header" href="#major-tasks">Major tasks</a></h3>
<h4 id="porting-application-to-risc-v"><a class="header" href="#porting-application-to-risc-v">Porting application to RISC-V</a></h4>
<p>In this task, you must choose an application you will be porting (for instance, your application for quadratic equation solution) and port it to RISC-V:</p>
<ul>
<li>Create a Makefile for your application. Makefile should have build and run on qemu targets, you must be able to change compiler and simulator (and also compilation flags)</li>
<li>For convenience, add Makefile target that runs on qemu / runs gdb / builds application using docker instead console:</li>
</ul>
<pre><code class="language-shell">make build-docker # This will enter docker container and build application inside it
</code></pre>
<ul>
<li>Build your app, verify that it runs on a simulator</li>
<li>Build with both GNU and LLVM toolchain. Try different optimization levels, compare assemblers. Compare them and list some differences.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="downloading-toolchain-and-compiling-your-own-1"><a class="header" href="#downloading-toolchain-and-compiling-your-own-1">Downloading toolchain and compiling your own</a></h2>
<ul>
<li>Show docker usage with riscv-tools image</li>
<li>Briefly show necessary tools from toolchain and how to work with them</li>
<li>Demonstrate building risc-v toolchain from sources</li>
<li>Demonstrate compiler output for sample app (GCC and CLANG)</li>
<li>Create sample app with Makefile and try compiling using custom toolchain, sc-dt toolchain
and thead toolchain</li>
<li>Run on qemu, connect with debugger and test out</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="learning-linkers"><a class="header" href="#learning-linkers">Learning linkers</a></h2>
<p>In this lab, you will gain hands-on experience with relocations, how linkers resolve them,
as well as get some knowledge about static / dynamic linking. Navigate to <code>labs/03-linkers</code> to see the examples we've prepared for you.</p>
<h3 id="definitions-and-declarations"><a class="header" href="#definitions-and-declarations">Definitions and declarations</a></h3>
<p><em>Declaration</em> in C introduces identifier and describes its type, whether it is a type, object or a function.</p>
<p><em>Definition</em> in C instantiates / implement the identifier. It is what linker needs in order to make references to those entities.</p>
<p>Take a look at following declarations:</p>
<pre><code class="language-c">extern int bar;
extern int mul(int a, int b);
double sum(int a, double b);
struct foo;
</code></pre>
<p>Take a look at <code>main.c</code> and <code>fact.c</code> provided.</p>
<pre><code class="language-c">int main() {
  unsigned f = fact(5);
  printf(&quot;%u\n&quot;, f);
  return 0;
}
</code></pre>
<pre><code class="language-c">unsigned fact(unsigned x) {
  if (x &lt; 2)
    return 1;

  return x * fact(x - 1);
}
</code></pre>
<p>First, let's from here use only <code>RISC-V toolchain</code>:</p>
<pre><code class="language-shell">source /opt/sc-dt/env.sh # NOTE: if you are using something other than bash, this might not work. If so, try the old fashioned path export
export CC=/opt/sc-dt/riscv-gcc/bin/
export PATH=${PATH}:/opt/sc-dt/riscv-gcc/bin
export PATH=${PATH}:/opt/sc-dt/tools/bin # For QEMU
</code></pre>
<p><code>main</code> here does not know that <code>fact</code> function exists. If we try to compile main to the executable <code>make exec</code>, we will get following error:</p>
<pre><code class="language-shell">/opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/../../../../riscv64-unknown-linux-gnu/bin/ld: /tmp/ccqIh9oC.o: in function `main':
main.c:(.text+0xa): undefined reference to `fact'
collect2: error: ld returned 1 exit status
</code></pre>
<p>Linker failed to find definition for <em>the definition</em> for <code>fact</code> function.</p>
<h4 id="task-31"><a class="header" href="#task-31">Task 3.1</a></h4>
<p>Use <code>readelf</code> and <code>file</code> utilities to investigate  <code>main.o</code> file and its contents and answer following questions:</p>
<p>Format for the following assignment: answer the questions in markdown file.</p>
<ul>
<li>What is the type of the file?</li>
<li>How many sections are there?</li>
<li>List all entries in the same format <code>readelf</code>
prints it</li>
<li>Why does entries for <code>print</code> and <code>fact</code> functions have <code>NOTYPE</code> type?</li>
<li>Modify the following example so executable is produced correctly.</li>
</ul>
<h3 id="relocations"><a class="header" href="#relocations">Relocations</a></h3>
<p>Let's take a look at <code>objdump</code> output:</p>
<pre><code>riscv64-unknown-linux-gnu-objdump -d main.o
</code></pre>
<p>We will notice that we have address of factorial function is all zeroes:</p>
<pre><code class="language-shell">    e:	000080e7          	jalr	ra # a &lt;main+0xa&gt;
</code></pre>
<p>Now compile both files and link into a single executable and look at the call address:</p>
<pre><code class="language-shell">make bin
</code></pre>
<pre><code class="language-shell">riscv64-unknown-linux-gnu-objdump -d fact | grep fact
</code></pre>
<p>You will see that fact now has been assigned an address and <code>main</code> nows how to call it:</p>
<pre><code class="language-shell">fact:     file format elf64-littleriscv
   105fc:	028000ef          	jal	ra,10624 &lt;fact&gt;
0000000000010624 &lt;fact&gt;:
   1063c:	00e7e463          	bltu	a5,a4,10644 &lt;fact+0x20&gt;
   10642:	a839                	j	10660 &lt;fact+0x3c&gt;
   1064e:	fd7ff0ef          	jal	ra,10624 &lt;fact&gt;

</code></pre>
<p>The linker managed to find <code>fact</code> function and insert the correct address for it. It used <em>relocations</em> to do it.</p>
<pre><code class="language-shell">riscv64-unknown-linux-gnu-readelf -r main.o
</code></pre>
<p>Possible output:</p>
<pre><code class="language-shell">Relocation section '.rela.text' at offset 0x268 contains 8 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
00000000000a  000c00000012 R_RISCV_CALL      0000000000000000 fact + 0
00000000000a  000000000033 R_RISCV_RELAX                        0
00000000001e  00080000001a R_RISCV_HI20      0000000000000000 .LC0 + 0
00000000001e  000000000033 R_RISCV_RELAX                        0
000000000022  00080000001b R_RISCV_LO12_I    0000000000000000 .LC0 + 0
000000000022  000000000033 R_RISCV_RELAX                        0
000000000026  000d00000012 R_RISCV_CALL      0000000000000000 printf + 0
000000000026  000000000033 R_RISCV_RELAX                        0
</code></pre>
<p>From the output we see that both <code>fact</code> and <code>printf</code> names calls have their relocations. These relocations are provided by compiler to asssist linker in resolving symbols.</p>
<h3 id="static-libraries"><a class="header" href="#static-libraries">Static libraries</a></h3>
<p>The following command:</p>
<pre><code>riscv64-unknown-linux-gnu-gcc main.c fact.c  -o fact
</code></pre>
<p>compiles program to executable. But no linker here is invoked? Or is it?</p>
<p>Pass <code>--verbose</code> flag to dive deeper into what gcc actually calls under the hood.</p>
<p>Find <code>collect2</code> call line:</p>
<pre><code>/opt/sc-dt/riscv-gcc/bin/../libexec/gcc/riscv64-unknown-linux-gnu/12.2.1/collect2 -plugin /opt/sc-dt/riscv-gcc/bin/../libexec/gcc/riscv64-unknown-linux-gnu/12.2.1/liblto_plugin.so -plugin-opt=/opt/sc-dt/riscv-gcc/bin/../libexec/gcc/riscv64-unknown-linux-gnu/12.2.1/lto-wrapper -plugin-opt=-fresolution=/tmp/cc1yCRZY.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --sysroot=/opt/sc-dt/riscv-gcc/bin/../sysroot --eh-frame-hdr -melf64lriscv -dynamic-linker /lib/ld-linux-riscv64-lp64d.so.1 -o fact /opt/sc-dt/riscv-gcc/bin/../sysroot/usr/lib64/lp64d/crt1.o /opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/crti.o /opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/crtbegin.o -L/opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1 -L/opt/sc-dt/riscv-gcc/bin/../lib/gcc -L/opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/../../../../riscv64-unknown-linux-gnu/lib/../lib64/lp64d -L/opt/sc-dt/riscv-gcc/bin/../sysroot/lib/../lib64/lp64d -L/opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/../../../../riscv64-unknown-linux-gnu/lib -L/opt/sc-dt/riscv-gcc/bin/../sysroot/lib64/lp64d -L/opt/sc-dt/riscv-gcc/bin/../sysroot/usr/lib64/lp64d -L/opt/sc-dt/riscv-gcc/bin/../sysroot/lib /tmp/ccOEmH9J.o /tmp/cc6v5KHP.o -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/crtend.o /opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/crtn.o

</code></pre>
<p><code>collect2</code> is the actual command called in the process of linking.</p>
<p>Try examining every argument and describe what it is responsible for.</p>
<p>Mostly all of the arguments are paths to libraries.</p>
<p>Static libraries are embedded to applications code directly.</p>
<p>Let's create or own little static library:</p>
<pre><code>riscv64-unknown-linux-gnu-ar cr libfact.o fact.o
</code></pre>
<p>Use <code>nm</code> utility to get the list of symbols available in the archive:</p>
<pre><code>riscv64-unknown-linux-gnu-nm libfact.o
</code></pre>
<pre><code>fact.o:
0000000000010294 r __abi_tag
0000000000012040 B __BSS_END__
0000000000012038 B __bss_start
0000000000012038 b completed.0
0000000000012000 D __DATA_BEGIN__
0000000000012000 D __data_start
0000000000012000 W data_start
000000000001048a t deregister_tm_clones
00000000000104d0 t __do_global_dtors_aux
0000000000011e18 d __do_global_dtors_aux_fini_array_entry
0000000000012030 D __dso_handle
0000000000011e20 d _DYNAMIC
0000000000012038 D _edata
0000000000012040 B _end
0000000000010524 T fact
00000000000104f2 t frame_dummy
0000000000011e10 d __frame_dummy_init_array_entry
0000000000010608 r __FRAME_END__
0000000000012020 d _GLOBAL_OFFSET_TABLE_
0000000000012800 A __global_pointer$
00000000000105cc r __GNU_EH_FRAME_HDR
0000000000011e18 d __init_array_end
0000000000011e10 d __init_array_start
0000000000012028 D _IO_stdin_used
00000000000105c2 T __libc_csu_fini
000000000001056a T __libc_csu_init
                 U __libc_start_main@GLIBC_2.27
000000000001047e t load_gp
00000000000104f4 T main
                 U printf@GLIBC_2.27
0000000000010410 t _PROCEDURE_LINKAGE_TABLE_
00000000000104a8 t register_tm_clones
0000000000012028 D __SDATA_BEGIN__
0000000000010450 T _start
0000000000012000 D __TMC_END__

</code></pre>
<p>To link with your static or dynamic library, pass <code>-llib</code>  argument to compilation flags. <code>lib</code> is the name of library.</p>
<p>Note that linking directly with <code>ld</code> is strongly discouraged, instead, use <code>gcc</code> or <code>clang</code> driver and pass additional options to linker if needed.</p>
<h4 id="task-32"><a class="header" href="#task-32">Task 3.2</a></h4>
<ul>
<li>Create a separare directory with files for your static library</li>
<li>Write Makefile target which creates static library</li>
<li>Use <code>nm</code> to find out what</li>
<li>Write Makefile target which links</li>
<li>Create your own static library for RISC-V. It would be even better if application was useful, for instance, a custom C logging library.</li>
</ul>
<h3 id="dynamic-linking"><a class="header" href="#dynamic-linking">Dynamic linking</a></h3>
<p>Static linking is portable, because all library code is embedded in the application and no platform support required. But this makes application's code size increase dramatically.</p>
<p>The solution to this problem is <strong>dynamic libraries</strong></p>
<p>Let's create our little dynamic library and link our application against it:</p>
<pre><code class="language-shell">CFLAGS=-fPIC make fact
riscv64-unknown-linux-gnu-gcc -shared fact.o -o libfact.so
</code></pre>
<pre><code class="language-shell">$ file libfact.so
libfact.so: ELF 64-bit LSB shared object, UCB RISC-V, RVC, double-float ABI, version 1 (SYSV), dynamically linked, not stripped

</code></pre>
<p>Now link your library against <code>libfact.so</code>:</p>
<pre><code>riscv64-unknown-linux-gnu-gcc main.o -o fact -lfact
/opt/sc-dt/riscv-gcc/bin/../lib/gcc/riscv64-unknown-linux-gnu/12.2.1/../../../../riscv64-unknown-linux-gnu/bin/ld: cannot find -lfact: No such file or directory
collect2: error: ld returned 1 exit status
</code></pre>
<p>This happened because our <code>libfact.so</code> is in the current working directory, and linker does not now it should look here.</p>
<p>You can pass paths where linker should search for the libraries with <code>-L</code> option:</p>
<pre><code>riscv64-unknown-linux-gnu-gcc main.o -o fact -L. -lfact
</code></pre>
<p>We told the linker to search for <code>libfact</code> inside our current working directory.</p>
<pre><code>file fact
fact: ELF 64-bit LSB executable, UCB RISC-V, RVC, double-float ABI, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-riscv64-lp64d.so.1, for GNU/Linux 4.15.0, not stripped
</code></pre>
<p>Now let's run it with qemu:</p>
<pre><code>‚ùØ qemu-riscv64 ./fact
./fact: error while loading2 shared libraries: libfact.so: cannot open shared object file: No such file or directory

</code></pre>
<p>What is wrong? We linker the library, didn't we?</p>
<p>The reason is that though we specified where to look for dynamic library, we didn't put that information in the binary.</p>
<p>Let's do it using <code>rpath</code>:</p>
<pre><code>riscv64-unknown-linux-gnu-gcc main.o -o fact -L. -lfact -Wl,-rpath,.
</code></pre>
<p>Now let's try again:</p>
<pre><code>qemu-riscv64  ./fact
./fact: error while loading shared libraries: libc.so.6: cannot open shared object file: No such file or directory
</code></pre>
<p>Now <code>qemu</code> failed to find the C standard library.
We already know how to fix it, let's pass path to <code>glibc</code>:</p>
<pre><code>‚ùØ qemu-riscv64 -L . -L /opt/sc-dt/riscv-gcc/sysroot/ ./fact
120
</code></pre>
<p>Our factorial finally works, and we learned to create dynamic libraries.</p>
<h4 id="task-33"><a class="header" href="#task-33">Task 3.3</a></h4>
<ul>
<li>Create your own little dynamic library. First do it with x86 toolchain, then for RISCV.</li>
<li>Link application with the library and make it run on QEMU and on LicheePi (when available).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="intro-to-linux-and-building-it-for-embedded-systems"><a class="header" href="#intro-to-linux-and-building-it-for-embedded-systems">Intro to Linux and building it for embedded systems</a></h2>
<p>In this lab you will be introduced to basic concepts from Linux based systems.
Basic structure and overview of linux distributions (or distros) will be presented.
You will use <code>qemu-system</code> to boot an existing image for LicheePi4A RISC-V SBC.</p>
<p>First of all, you need to build some of the required tools and download a system image,
which you will need going forth. Following the <a href="04-linux-intro/">preparations</a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>The official linux distro for Lichee PI 4A is <a href="https://wiki.sipeed.com/hardware/en/lichee/th1520/lpi4a/7_develop_revyos.html">revyos</a></p>
<h2 id="revyos-image"><a class="header" href="#revyos-image">Revyos image</a></h2>
<p>Download a prebuilt system image from the manufacturer <a href="https://wiki.sipeed.com/hardware/en/lichee/th1520/lpi4a/3_images.html">here</a>.
Here's a direct <a href="https://mega.nz/folder/phoQlBTZ#cZeQ3qZ__pDvP94PT3_bGA/file/k4Bg2BCD">link</a>. Please choose the latest LPI4A_BASIC archive.
Mega has arbitrary restrictions on download size, so LPI4A_FULL is too large and you will get throttled.</p>
<h3 id="distrobox-for-building-inside-ubuntu-2204-container"><a class="header" href="#distrobox-for-building-inside-ubuntu-2204-container">Distrobox for building inside ubuntu-22.04 container.</a></h3>
<p>Distrobox is a tool for working inside OCI containers in your shell. Visit the <a href="https://github.com/89luca89/distrobox/">homepage</a>
or the official <a href="https://distrobox.it/">website</a>. Follow the installation instructions for your distribution.</p>
<p>Excerpt from the official installation docs:</p>
<blockquote>
<p>If you like to live your life dangerously, or you want the latest release,
you can trust [the author of distrobox] and simply run this in your terminal:</p>
</blockquote>
<pre><code class="language-bash">curl -s https://raw.githubusercontent.com/89luca89/distrobox/main/install | sudo sh
# or using wget
wget -qO- https://raw.githubusercontent.com/89luca89/distrobox/main/install | sudo sh
</code></pre>
<p>After you've installed distrobox you can create a fresh <code>ubuntu-22.04</code> container with a
single command:</p>
<pre><code class="language-bash">distrobox create --image ubuntu:22.04 --name ubuntu-22.04-revyos-sdk
</code></pre>
<p>When the command has finished downloading OCI container image you can enter it like so:</p>
<pre><code class="language-bash">distrobox enter ubuntu-22.04-revyos-sdk
</code></pre>
<p><strong>All of the subsequent instructions assume you are working inside the newly created container.</strong>
If you have any questions/problems please refer to the official <a href="https://distrobox.it/#quick-start">quick-start guide</a>.</p>
<h3 id="build-revyos-qemu"><a class="header" href="#build-revyos-qemu">Build RevyOS QEMU</a></h3>
<p>Vendor has implemented some custom RISC-V spec <em>extensions</em>, so in order to run binaries compiled for their system you will
need a build of custom QEMU.</p>
<h4 id="build-instructions-for-ubuntu-2204"><a class="header" href="#build-instructions-for-ubuntu-2204">Build instructions for <code>ubuntu-22.04</code>.</a></h4>
<p>Install the build-time dependencies.</p>
<pre><code class="language-bash">sudo apt install ninja-build python3-venv build-essential libglib2.0-dev flex bison libpixman-1-dev git fdisk file tsocks
</code></pre>
<p>Fetch the repository and compile it from source.</p>
<pre><code class="language-bash">git clone https://github.com/revyos/qemu revyos-qemu
cd revyos-qemu
git submodule init
git submodule update --recursive
./configure --target-list=riscv64-softmmu,riscv64-linux-user --with-git='tsocks git'
make -j $(nproc)
sudo make install # This will install qemu-riscv64 and qemu-system-riscv64 inside the container
# Your host system will not be affected.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>You will need to complete all of the steps described in the <a href="04-linux-intro/04-linux-intro/01-preparations.html">preparations</a>.
Do not forget to enter the container with <code>distrobox enter ubuntu-22.04-revyos-sdk</code>.</p>
<h3 id="mounting-the-filesystem"><a class="header" href="#mounting-the-filesystem">Mounting the filesystem</a></h3>
<pre><code class="language-bash">mkdir revyos-with-qemu
cd revyos-with-qemu
cp &lt;path to LPI4A_BASIC_20240111.zip&gt; ./
unzip LPI4A_BASIC_20240111.zip
# Archive:  LPI4A_BASIC_20240111.zip
#    creating: LPI4A_BASIC_20240111/
#   inflating: LPI4A_BASIC_20240111/root.ext4
#   inflating: LPI4A_BASIC_20240111/boot.ext4
#   inflating: LPI4A_BASIC_20240111/flash_image.sh
#   inflating: LPI4A_BASIC_20240111/fastboot
#   inflating: LPI4A_BASIC_20240111/u-boot-with-spl-lpi4a.bin
#   inflating: LPI4A_BASIC_20240111/u-boot-with-spl-lpi4a-16g.bin 
</code></pre>
<p>The extracted image contains:</p>
<ul>
<li><code>u-boot-with-spl-lpi4a.bin</code> - This is the secondary program loader (SPL) and primary uboot for 8Gb DDR board.</li>
<li><code>u-boot-with-spl-lpi4a-16g.bin</code> - Same as <code>u-boot-with-spl-lpi4a.bin</code>, but for the 16Gb variant.</li>
<li><code>root.ext4</code> - Root filesystem</li>
<li><code>boot.ext4</code> - Boot partition</li>
</ul>
<pre><code class="language-bash">fdisk -l LPI4A_BASIC_20240111/root.ext4
# Disk LPI4A_BASIC_20240111/root.ext4: 4 GiB, 4294967296 bytes, 8388608 sectors
# Units: sectors of 1 * 512 = 512 bytes
# Sector size (logical/physical): 512 bytes / 512 bytes
# I/O size (minimum/optimal): 512 bytes / 512 bytes
fdisk -l LPI4A_BASIC_20240111/boot.ext4
# Disk LPI4A_BASIC_20240111/boot.ext4: 500 MiB, 524288000 bytes, 1024000 sectors
# Units: sectors of 1 * 512 = 512 bytes
# Sector size (logical/physical): 512 bytes / 512 bytes
# I/O size (minimum/optimal): 512 bytes / 512 bytes
</code></pre>
<p>In order to view the contents of the filesystems you need to mount them.</p>
<pre><code class="language-bash">sudo mkdir /mnt/boot /mnt/root -p
sudo mount LPI4A_BASIC_20240111/boot.ext4 /mnt/boot -v
# mount: /dev/loop0 mounted on /mnt/boot.
sudo mount LPI4A_BASIC_20240111/root.ext4 /mnt/root -v
# mount: /dev/loop1 mounted on /mnt/root.
cd /mnt/boot
# ‚¨¢ [Docker] ‚ùØ lla
# Permissions Size User Date Modified Name
# drwxr-xr-x     - root  9 Oct  2023  Óóø dtbs
# drwxr-xr-x     - root 14 Dec  2023  Óóø extlinux
# drwx------     - root  9 Oct  2023  Óóø lost+found
# .rw-r--r--  167k root  6 Sep  2023  ÔÖõ config-5.10.113-lpi4a
# .rwxr-xr-x   86k root  8 Oct  2023  Ó´® fw_dynamic.bin
# .rwxr-xr-x   23M root 20 Dec  2023  ÔÄñ Image
# .rw-r--r--  5.2M root  9 Oct  2023  ÔÖõ initrd.img-5.10.113-lpi4a
# .rwxr-xr-x   50k root  6 Sep  2023  Ó´® light_aon_fpga.bin
# .rwxr-xr-x  6.1M root  8 Oct  2023  Ó´® light_c906_audio.bin
# .rw-r--r--  6.2M root  6 Sep  2023  ÔÖõ System.map-5.10.113-lpi4a
# .rwxr-xr-x   23M root  6 Sep  2023  ÔÖõ vmlinux-5.10.113-lpi4a
</code></pre>
<p>Files of the primary interest are:</p>
<ul>
<li><code>fw_dynamic.bin</code> - OpenSBI with dynamic information. More info at <a href="https://github.com/riscv-software-src/opensbi/blob/master/docs/firmware/fw_dynamic.md">fw_dynamic.md</a></li>
<li><code>dtbs</code> - Compiled device tree binaries.</li>
<li><code>Image</code> - Kernel, which is run by the bootloader (uboot). This is a statically linked binary.</li>
<li><code>vmlinux-5.10.113-lpi4a</code> - Kernel binary produced during the compilation process. Is not bootable.</li>
<li><code>initrd.img-5.10.113-lpi4a</code> - Initial ram disk for <em>Phase 1</em> init before rootfs can be mounted.</li>
</ul>
<p>To view the contents of <code>initrd</code> it first needs to be uncompressed.</p>
<pre><code class="language-bash">cd &lt;path to revyos-with-qemu&gt;
cp /mnt/boot/initrd.img-5.10.113-lpi4a .
file initrd.img-5.10.113-lpi4a
# initrd.img-5.10.113-lpi4a: gzip compressed data, was &quot;mkinitramfs-MAIN_oNzF9f&quot;, last modified: Mon Oct  9 14:10:38 2023, from Unix, original size modulo 2^32 12879360
gunzip initrd.img-5.10.113-lpi4a -d -c &gt; initrd.img-5.10.113-lpi4a.cpio
file initrd.img-5.10.113-lpi4a.cpio
# initrd.img-5.10.113-lpi4a.cpio: ASCII cpio archive (SVR4 with no CRC)
cpio --list -i &lt; ./initrd.img-5.10.113-lpi4a.cpio | head -n 15
# .
# bin
# conf
# conf/arch.conf
# conf/conf.d
# conf/initramfs.conf
# etc
# etc/fstab
# etc/ld.so.cache
# etc/ld.so.conf
# etc/ld.so.conf.d
# etc/ld.so.conf.d/libc.conf
# etc/ld.so.conf.d/riscv64-linux-gnu.conf
# etc/modprobe.d
# etc/mtab
# 25155 blocks
mkdir initrd-contents
cpio -idmv &lt; ../initrd.img-5.10.113-lpi4a.cpio
# ‚¨¢ [Docker] ‚ùØ lla
# Permissions Size Date Modified Name
# lrwxrwxrwx     - 26 Mar 12:02  Óóø bin -&gt; usr/bin
# drwxr-xr-x     - 26 Mar 12:02  Óóø conf
# drwxr-xr-x     - 26 Mar 12:02  Óóº etc
# lrwxrwxrwx     - 26 Mar 12:02  Óóø lib -&gt; usr/lib
# drwxr-xr-x     -  9 Oct  2023  ÔÑï run
# lrwxrwxrwx     - 26 Mar 12:02  Óóø sbin -&gt; usr/sbin
# drwxr-xr-x     - 26 Mar 12:02  Óóø scripts
# drwxr-xr-x     - 26 Mar 12:02  Óóø usr
# .rwxr-xr-x  6.6k 10 Apr  2022  ÔÄñ init
</code></pre>
<h3 id="running-the-extracted-image-with-qemu"><a class="header" href="#running-the-extracted-image-with-qemu">Running the extracted image with QEMU</a></h3>
<p>Now that we have everything extracted it's easy to run the image
with the custom vendor fork of qemu, which you've previously compiled from source.</p>
<p>First you will need to modify the <code>/mnt/root/etc/fstab</code> file a bit.
Replace the contents of the file with the following:</p>
<pre><code># UNCONFIGURED FSTAB FOR BASE SYSTEM
/dev/vda /   auto    defaults    1 1
/dev/vdb /boot   auto    defaults    0 0
</code></pre>
<p>To do this you can use your faviourite editor.</p>
<pre><code class="language-bash">echo &quot;# UNCONFIGURED FSTAB FOR BASE SYSTEM
/dev/vda /   auto    defaults    1 1
/dev/vdb /boot   auto    defaults    0 0
&quot; &gt; fstab
sudo cp fstab /mnt/root/etc/fstab
cat /mnt/root/etc/fstab
# # UNCONFIGURED FSTAB FOR BASE SYSTEM
# /dev/vda /   auto    defaults    1 1
# /dev/vdb /boot   auto    defaults    0 0
</code></pre>
<p>Now you can launch qemu with the following command:</p>
<pre><code class="language-bash">sudo umount /mnt/root
e2fsck -y LPI4A_BASIC_20240111/root.ext4
e2fsck -y LPI4A_BASIC_20240111/boot.ext4
sync
revyos-qemu/build/qemu-system-riscv64 -M virt -cpu c910v -smp 1 -m 3G -kernel /mnt/boot/Image -append &quot;root=/dev/vda rw console=ttyS0&quot; -drive file=LPI4A_BASIC_20240111/root.ext4,format=raw,id=hd0 -device virtio-blk-device,drive=hd0 -drive file=LPI4A_BASIC_20240111/boot.ext4,format=raw,id=hd1 -device virtio-blk-device,drive=hd1 -initrd /mnt/boot/initrd.img-5.10.113-lpi4a -nographic
</code></pre>
<p>You will see the boot log that looks something like this:</p>
<pre><code>OpenSBI v0.9
   ____                    _____ ____ _____
  / __ \                  / ____|  _ \_   _|
 | |  | |_ __   ___ _ __ | (___ | |_) || |
 | |  | | '_ \ / _ \ '_ \ \___ \|  _ &lt; | |
 | |__| | |_) |  __/ | | |____) | |_) || |_
  \____/| .__/ \___|_| |_|_____/|____/_____|
        | |
        |_|

Platform Name             : riscv-virtio,qemu
Platform Features         : timer,mfdeleg
Platform HART Count       : 1
Firmware Base             : 0x80000000
Firmware Size             : 100 KB
Runtime SBI Version       : 0.2

....

[    0.000000] Linux version 5.10.113+ (ubuntu@ubuntu-2204-buildserver) (riscv64-unknown-linux-gnu-gcc (Xuantie-900 linux-5.10.4 glibc gcc Toolchain V2.6.1 B-20220906) 10.2.0, GNU ld (GNU Binutils) 2.35) #1 SMP PREEMPT Wed Dec 20 08:25:29 UTC 2023
[    0.000000] OF: fdt: Ignoring memory range 0x80000000 - 0x80200000
[    0.000000] efi: UEFI not found.
[    0.000000] Initial ramdisk at: 0x(____ptrval____) (5160960 bytes)
[    0.000000] Zone ranges:
[    0.000000]   DMA32    [mem 0x0000000080200000-0x00000000ffffffff]
[    0.000000]   Normal   [mem 0x0000000100000000-0x000000013fffffff]
[    0.000000] Movable zone start for each node
[    0.000000] Early memory node ranges
[    0.000000]   node   0: [mem 0x0000000080200000-0x000000013fffffff]
</code></pre>
<p>After a while you should see the login prompt:</p>
<pre><code class="language-bash">[  OK  ] Started serial-getty@ttyS0‚Ä¶rvice - Serial Getty on ttyS0.
[  OK  ] Reached target getty.target - Login Prompts.
[  OK  ] Reached target multi-user.target - Multi-User System.
[  OK  ] Reached target graphical.target - Graphical Interface.
         Starting systemd-update-ut‚Ä¶ Record Runlevel Change in UTMP...
[  OK  ] Finished systemd-update-ut‚Ä¶ - Record Runlevel Change in UTMP.

Debian GNU/Linux 12 lpi4a ttyS0

lpi4a login:
</code></pre>
<p>Enter the default login <code>debian</code> and password <code>debian</code> as documented in the <a href="https://wiki.sipeed.com/hardware/en/lichee/th1520/lpi4a/3_images.html">docs</a>.</p>
<p>You should now be in the shell:</p>
<pre><code>
   ____              _ ____  ____  _  __  ____  _                     _
  |  _ \ _   _ _   _(_) ___||  _ \| |/ / / ___|(_)_ __   ___  ___  __| |
  | |_) | | | | | | | \___ \| | | | ' /  \___ \| | '_ \ / _ \/ _ \/ _` |
  |  _ &lt;| |_| | |_| | |___) | |_| | . \   ___) | | |_) |  __/  __/ (_| |
  |_| \_\\__,_|\__, |_|____/|____/|_|\_\ |____/|_| .__/ \___|\___|\__,_|
               |___/                             |_|
                                        -- Presented by ISCAS and Sipeed

  Debian GNU/Linux 12 (bookworm) (kernel 5.10.113+)

Linux lpi4a 5.10.113+ #1 SMP PREEMPT Wed Dec 20 08:25:29 UTC 2023 riscv64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
debian@lpi4a:~$
</code></pre>
<p>The image contains python3 so you can run a basic hello-world in the python repl:</p>
<pre><code class="language-bash">python3
# Python 3.11.4 (main, Jun  7 2023, 10:13:09) [GCC 12.2.0] on linux
# Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
# &gt;&gt;&gt; print(&quot;Hello, World&quot;)
# Hello, World
&lt;Ctrl + D&gt;
</code></pre>
<p>Run <code>uname</code> utility to print the information about current machine:</p>
<pre><code class="language-bash">uname -a
# Linux lpi4a 5.10.113+ #1 SMP PREEMPT Wed Dec 20 08:25:29 UTC 2023 riscv64 GNU/Linux
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-buildroot-to-cross-compile-embedded-linux-systems"><a class="header" href="#using-buildroot-to-cross-compile-embedded-linux-systems">Using buildroot to cross-compile embedded linux systems</a></h2>
<blockquote>
<p>Buildroot is a simple, efficient and easy-to-use tool to generate embedded Linux systems through cross-compilation.</p>
</blockquote>
<p>Buildroot is a widely used tool for cross-compilation. It's quite easy to use
compared to alternatives like <a href="https://www.yoctoproject.org/">yocto</a>.
It takes care of bootstrapping a suitable toolchain with support for various
standard library implementations (glibc, musl, uClibc-ng). Most importantly
it can build rootfs from scratch including the necessary bootloaders.</p>
<p>In this lab we will be using mainline buildroot to build a bootable disk image
for Sipeed LP4A.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="cross-compiling-a-system-for-risc-v-with-buildroot"><a class="header" href="#cross-compiling-a-system-for-risc-v-with-buildroot">Cross compiling a system for RISC-V with Buildroot</a></h2>
<h3 id="getting-buildroot"><a class="header" href="#getting-buildroot">Getting buildroot</a></h3>
<p>First off you will need to install dependencies and download mainline buildroot.</p>
<pre><code class="language-bash">wget https://buildroot.org/downloads/buildroot-2024.02.1.tar.gz
tar -xzvf buildroot-2024.02.1.tar.gz
cd buildroot-2024.02.1/
sudo apt install libncurses-dev file cpio libssl-dev fdisk dosfstools cmake ccache build-essential
</code></pre>
<p>Create a <code>defconfig</code> file with the following command. This defines minimal set
of buildroot options.</p>
<pre><code class="language-bash">echo 'BR2_riscv=y
BR2_RISCV_ISA_RVC
BR2_TOOLCHAIN_BUILDROOT_MUSL=y
BR2_PACKAGE_HOST_LINUX_HEADERS_CUSTOM_5_10=y
BR2_GCC_VERSION_13_X=y
BR2_LINUX_KERNEL=y
BR2_LINUX_KERNEL_CUSTOM_GIT=y
BR2_LINUX_KERNEL_CUSTOM_REPO_URL=&quot;https://github.com/revyos/thead-kernel&quot;
BR2_LINUX_KERNEL_CUSTOM_REPO_VERSION=&quot;lpi4a&quot;
BR2_LINUX_KERNEL_DEFCONFIG=&quot;revyos&quot;
BR2_LINUX_KERNEL_DTS_SUPPORT=y
BR2_LINUX_KERNEL_INTREE_DTS_NAME=&quot;thead/light-lpi4a&quot;
BR2_LINUX_KERNEL_NEEDS_HOST_PAHOLE=y
BR2_TARGET_ROOTFS_EXT2=y
BR2_TARGET_ROOTFS_EXT2_4=y
BR2_TARGET_ROOTFS_EXT2_SIZE=&quot;512M&quot;
BR2_TARGET_ROOTFS_INITRAMFS=y
# BR2_TARGET_ROOTFS_TAR is not set
BR2_TARGET_OPENSBI=y
BR2_TARGET_OPENSBI_CUSTOM_GIT=y
BR2_TARGET_OPENSBI_CUSTOM_REPO_URL=&quot;https://github.com/revyos/opensbi&quot;
BR2_TARGET_OPENSBI_CUSTOM_REPO_VERSION=&quot;th1520-v1.4&quot;
BR2_TARGET_OPENSBI_PLAT=&quot;generic&quot;
# BR2_TARGET_OPENSBI_INSTALL_JUMP_IMG is not set
BR2_TARGET_UBOOT=y
BR2_TARGET_UBOOT_BUILD_SYSTEM_KCONFIG=y
BR2_TARGET_UBOOT_CUSTOM_GIT=y
BR2_TARGET_UBOOT_CUSTOM_REPO_URL=&quot;https://github.com/revyos/thead-u-boot&quot;
BR2_TARGET_UBOOT_CUSTOM_REPO_VERSION=&quot;th1520&quot;
BR2_TARGET_UBOOT_BOARD_DEFCONFIG=&quot;light_lpi4a&quot;
BR2_TARGET_UBOOT_NEEDS_OPENSBI=y
BR2_TARGET_UBOOT_SPL=y
BR2_PACKAGE_HOST_UBOOT_TOOLS=y' &gt; defconfig
</code></pre>
<p>Then create <code>.config</code> via <code>make</code>:</p>
<pre><code>make defconfig BR2_DEFCONFIG=./defconfig
</code></pre>
<p>Now the only thing left to do is launch <code>make</code> and wait till completion.
Depending on the machine this might take a while.</p>
<p>Next you will need to fetch vendor-provided binary blobs (boot firmware):</p>
<pre><code>wget https://github.com/revyos/th1520-boot-firmware/archive/refs/tags/20240127+sdk1.4.2.tar.gz
tar -xzvf 20240127+sdk1.4.2.tar.gz
</code></pre>
<p>Now we can create out boot filesystem partition:</p>
<pre><code>dd if=/dev/zero of=output/images/bootfs.ext4 bs=4M count=32 &amp;&amp; sync
sudo mkfs.ext4 output/images/bootfs.ext4
sudo mkdir /mnt/boot -p
sudo mount output/images/bootfs.ext4 /mnt/boot
sudo mkdir /mnt/boot/extlinux/dtbs -p
sudo cp output/images/fw_dynamic.bin output/images/Image /mnt/boot
sudo cp th1520-boot-firmware-20240127-sdk1.4.2/addons/boot/light_* /mnt/boot/
sudo cp output/images/light-lpi4a.dtb /mnt/boot/extlinux/dtbs
sudo rm /mnt/boot/lost+found -rf
</code></pre>
<p>Create <code>extlinux.conf</code>:</p>
<pre><code class="language-bash">echo 'DEFAULT makeshiftos-default
MENU TITLE ------------------------------------------------------------
TIMEOUT 50

label makeshiftos-default
  MENU LABEL MakeShiftOS Default
  LINUX /Image
  FDT dtbs/light-lpi4a.dtb
  append root=/dev/mmcblk0p3 console=ttyS0,115200 rootwait rw earlycon clk_ignore_unused loglevel=7 eth= rootrwoptions=rw,noatime rootrwreset=yes' &gt; extlinux.conf
sudo mv extlinux.conf /mnt/boot/extlinux/extlinux.conf
</code></pre>
<p>Unmount the filesystem and flash it to the LP4A board:</p>
<pre><code>sync
sudo umount /mnt/boot
</code></pre>
<pre><code>sudo ./fastboot flash ram output/images/u-boot-spl.bin
sudo ./fastboot reboot
sudo ./fastboot flash uboot output/images/u-boot-spl.bin
sudo ./fastboot flash boot output/images/bootfs.ext4
sudo ./fastboot flash root output/images/rootfs.ext4
</code></pre>
<p>(Optional) When connecting via UART you will need to set serial options in
the following way:</p>
<pre><code>sudo stty -F /dev/ttyUSB0 ispeed 115200 ospeed 115200 cs8 raw
</code></pre>
<h3 id="references"><a class="header" href="#references">References</a></h3>
<ul>
<li><a href="https://archive.fosdem.org/2019/schedule/event/riscvbuildroot/attachments/slides/3040/export/events/attachments/riscvbuildroot/slides/3040/FOSDEM_2019_Buildroot_RISCV.pdf">Mark Corbin _ Buildroot for RISC-V</a></li>
<li><a href="https://www.youtube.com/watch?v=cIkTh3Xp3dA&amp;t=1333s">Bootlin _ Embedded Linux from Scratch in 45 minutes, on RISC-V</a></li>
<li><a href="https://www.youtube.com/watch?v=KQjRnuwb7is">David Hand _ &quot;Linux initramfs for fun, and, uh...&quot;</a></li>
<li><a href="https://www.youtube.com/watch?v=m_NyYEBxfn8">Device Tree for Dummies! - Thomas Petazzoni, Free Electrons</a></li>
<li><a href="https://www.youtube.com/watch?v=vcAVx8CV2fY">Kernel Recipes 2022 - Linux on RISC-V</a></li>
<li><a href="https://popovicu.com/posts/risc-v-sbi-and-full-boot-process/">RISC-V SBI and the full boot process</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
